name: Daily AI Fund Advisor V15 (Iron Fist)

on:
  # 1. 定时触发：北京时间 14:20 (UTC 06:20)
  schedule:
    - cron: '20 6 * * 1-5'

  # 2. 手动触发：用于开发调试
  workflow_dispatch:

jobs:
  run_advisor:
    runs-on: ubuntu-latest
    
    env:
      TZ: Asia/Shanghai

    steps:
    - name: Checkout code
      uses: actions/checkout@v4  # 升级到 v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5 # 升级到 v5
      with:
        python-version: "3.10"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Run V15 Iron Fist Advisor
      env:
        LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
        LLM_MODEL: ${{ secrets.LLM_MODEL }}
        MAIL_USER: ${{ secrets.MAIL_USER }}
        MAIL_PASS: ${{ secrets.MAIL_PASS }}
      run: |
        python main.py
        
    - name: Archive Portfolio Data
      if: always()
      uses: actions/upload-artifact@v4  # 核心修复：升级到 v4
      with:
        name: portfolio-data
        path: portfolio.json
        retention-days: 90
        overwrite: true # v4 新增参数，允许覆盖旧构件，避免报错
